$applicationId_to_name_map = @{
    "1b730954-1685-4b74-9bfd-dac224a7b894" ="Graph API"
    "90f610bf-206d-4950-b61d-37fa6fd1b224" ="AADRM"
    "a0c73c16-a7e3-4564-9a95-2bdf47383716" ="EXO Remote PowerShell"
    "d924a533-3729-4708-b3e8-1d2445af35e3" ="Skype"
    "00000006-0000-0ff1-ce00-000000000000" ="Office portal"
    "00000003-0000-0ff1-ce00-000000000000" ="SharePoint Online"
    "00000002-0000-0ff1-ce00-000000000000" ="Exchange Online"
    "00000007-0000-0000-c000-000000000000" ="Dynamics CRM"
    "4345a7b9-9a63-4910-a426-35363201d503" ="O365 Suite UX"
    "cb1056e2-e479-49de-ae31-7812af012ed8" ="Azure AD Sync"
    "6eb59a73-39b2-4c23-a70f-e2e3ce8965b1" ="AAD Connect v2"
    "1651564e-7ce4-4d99-88be-0a65050d8dc3" ="Sync client"
    "c44b4083-3bb0-49c1-b47d-974e53cbdf3c" ="Azure Admin Web UI"
    "4990cffe-04e8-4e8b-808a-1175604b879" ="Microsoft Dev Center"
    "89bee1f7-5e6e-4d8a-9f3d-ecd601259da7" ="Office365 Shell WCSS-Client"
    "d3590ed6-52b3-4102-aeff-aad2292ab01c" ="Microsoft Office"
    "57fb890c-0dab-4253-a5e0-7188c88b2bb4" ="SharePoint Online Client"
    "bc59ab01-8403-45c6-8796-ac3ef710b3e3" ="Outlook Online Add-in App"
    "2a0c3efa-ba54-4e55-bdc0-770f9e39e9ee" ="PowerBI content pack"
    "0000000c-0000-0000-c000-000000000000" ="Microsoft App Access Panel"
    "389b1b32-b5d5-43b2-b339-36da233a3be2" ="Office Management API Editor"
    "ab9b8c07-8f02-4f72-87fa-80105867a763" ="OneDrive Sync Engine"
    "74658136-14ec-4630-ad9b-26e160ff0fc6" ="Azure portal UI"
    "27922004-5251-4030-b22d-91ecd9a37ea4" ="MS MAM Service API"
    "5e3ce6c0-2b1f-4285-8d4b-75ee78787346" ="Teams web client"
    "7492bca1-9461-4d94-8eb8-c17896c61205" ="Microsoft Azure Graph Client Library 2.1.9 Internal"
    "84070985-06ea-473d-82fe-eb82b4011c9d" ="Windows Azure Service Management API"
    "1950a258-227b-4e31-a9cf-717495945fc2" ="AZ PowerShell Module"
    "f8d98a96-0999-43f5-8af3-69971c7bb423" ="Apple Internet Accounts"
    "7f59a773-2eaf-429c-a059-50fc5bb28b44" ="Global Admin Elevate Access"
    "9bc3ab49-b65d-410a-85ad-de819febfddc" ="SPO Management Shell"
    "06c6433f-4fb8-4670-b2cd-408938296b8e" ="AAD Pin redemption client"
    "19db86c3-b2b9-44cc-b669-d66bc9f2a36e" ="My Sign-ins"
    "00b41c95-dab0-4487-9791-b9d2c32c80f2" ="Office 365 Management (mobile app)"
    "29d9ed98-a469-4536-ade2-f981bc1d605e" ="Microsoft Azure MDM client"
    "6f7e0f60-9401-4f5b-98e2-cf15bd5fd5e3" ="Microsoft.AAD.BrokerPlugin"
    "38aa3b87-a06d-4817-b275-7a316988d93b" ="Microsoft AAD Cloud AP"
    "0c1307d4-29d6-4389-a11c-5cbe7f65d7fa" ="Azure Android App"
    "6c7e8096-f593-4d72-807f-a5f86dcc9c77" ="Intune MAM client"
    "4813382a-8fa7-425e-ab75-3b753aab3abb" ="Authenticator App"
    "1fec8e78-bce4-4aaf-ab1b-5451cc387264" ="Teams client"
    "de0853a1-ab20-47bd-990b-71ad5077ac7b" ="Windows Configuration Designer (WCD)"
    "b90d5b8f-5503-4153-b545-b31cecfaece2" ="AADJ CSP"
    "fb78d390-0c51-40cd-8e17-fdbfab77341b" ="Microsoft Exchange REST API Based Powershell"
    "18ed3507-a475-4ccb-b669-d66bc9f2a36e" ="Microsoft_AAD_RegisteredApps"
    "cc15fd57-2c6c-4117-a88c-83b1d56b4bbe"="Microsoft Teams Services"
    "3090ab82-f1c1-4cdf-af2c-5d7a6f3e2cc7"="Microsoft Defender for Cloud Apps"
    "99b904fd-a1fe-455c-b86c-2f9fb1da7687"="Microsoft Exchange ForwardSync"
    "13937bba-652e-4c46-b222-3003f4d1ff97"="Substrate Context Service"
    "94c63fef-13a3-47bc-8074-75af8c65887a"="Office Delve"
    "d9b8ec3a-1e4e-4e08-b3c2-5baf00c0fcb0"="HxService"
    "8edd93e1-2103-40b4-bd70-6e34e586362d"="Windows Azure Security Resource Provider"
    "2d7f3606-b07d-41d1-b9d2-0d0c9296a6e8"="Microsoft Bing Search for Microsoft Edge"
    "e64aa8bc-8eb4-40e2-898b-cf261a25954f"="CRM Power BI Integration"
    "00000009-0000-0000-c000-000000000000"="Power BI Service"
    "9ea1ad79-fdb6-4f9a-8bc3-2b70f96e34c7"="Bing"
    "a3475900-ccec-4a69-98f5-a65cd5dc5306"="Partner Customer Delegated Admin Offline Processor"
    "ee272b19-4411-433f-8f28-5c13cb6fd407"="Microsoft 365 Support Service"
    "fdf9885b-dd37-42bf-82e5-c3129ef5a302"="Microsoft Support"
    "00000007-0000-0ff1-ce00-000000000000"="Microsoft Exchange Online Protection"
    "2abdc806-e091-4495-9b10-b04d93c3f040"="Office Online Client AAD- Augmentation Loop"
    "6253bca8-faf2-4587-8f2f-b056d80998a7"="Microsoft Edge Insider Addons Prod"
    "00000004-0000-0ff1-ce00-000000000000"="Skype for Business Online"
    "ae8e128e-080f-4086-b0e3-4c19301ada69"="Scheduling"
    "ffcb16e8-f789-467c-8ce9-f826a080d987"="SharedWithMe"
    "66a88757-258c-4c72-893c-3e8bed4d6899"="Office 365 Search Service"
    "28b567f6-162c-4f54-99a0-6887f387bbcc"="Microsoft Storefronts"
    "00000005-0000-0ff1-ce00-000000000000"="Viva Engage (formerly Yammer)"
    "2d4d3d8e-2be3-4bef-9f87-7875a61c29de"="OneNote"
    "37182072-3c9c-4f6a-a4b3-b3f91cacffce"="AzureSupportCenter"
    "b23dd4db-9142-4734-867f-3577f640ad0c"="Office Online Client AAD- Loki"
    "26a7ee05-5602-4d76-a7ba-eae8b7b67941"="Windows Search"
    "62256cef-54c0-4cb4-bcac-4c67989bdc40"="OMSOctopiPROD"
    "35d54a08-36c9-4847-9018-93934c62740c"="PeoplePredictions"
    "4d5c2d63-cf83-4365-853c-925fd1a64357"="OfficeShredderWacClient"
    "65d91a3d-ab74-42e6-8a2f-0add61688c74"="Microsoft Approval Management"
    "16aeb910-ce68-41d1-9ac3-9e1673ac9575"="IrisSelectionFrontDoor"
    "b669c6ea-1adf-453f-b8bc-6d526592b419"="Focused Inbox"
    "95de633a-083e-42f5-b444-a4295d8e9314"="Microsoft Whiteboard Services"
    "871c010f-5e61-4fb1-83ac-98610a7e9110"="Microsoft Power BI"
    "835b2a73-6e10-4aa5-a979-21dfda45231c"="Azure Lab Services Portal"
    "e9f49c6b-5ce5-44c8-925d-015017e9f7ad"="Azure Data Lake"
    "bdd48c81-3a58-4ea9-849c-ebea7f6b6360"="Password Breach Authenticator"
    "00000003-0000-0000-c000-000000000000"="Microsoft Graph"
    "60c8bde5-3167-4f92-8fdb-059f6176dc0f"="Enterprise Roaming and Backup"
    "4765445b-32c6-49b0-83e6-1d93765276ca"="OfficeHome"
    "a3b79187-70b2-4139-83f9-6016c58cd27b"="WindowsDefenderATP Portal"
    "93d53678-613d-4013-afc1-62e9e444a0a5"="Office Online Add-in SSO"
    "69893ee3-dd10-4b1c-832d-4870354be3d8"="AEM-DualAuth"
    "04b07795-8ddb-461a-bbee-02f9e1bf7b46"="Microsoft Azure CLI"
    "00000002-0000-0000-c000-000000000000"="Windows Azure Active Directory"
    "c35cb2ba-f88b-4d15-aa9d-37bd443522e1"="GroupsRemoteApiRestClient"
    "a57aca87-cbc0-4f3c-8b9e-dc095fdc8978"="IAM Supportability"
    "944f0bd1-117b-4b1c-af26-804ed95e767e"="Media Analysis and Transformation Service"
    "fc0f3af4-6835-4174-b806-f7db311fd2f3"="Microsoft Intune Windows Agent"
    "a970bac6-63fe-4ec5-8884-8536862c42d4"="Substrate Search Settings Management Service"
    "3c896ded-22c5-450f-91f6-3d1ef0848f6e"="WeveEngine"
    "cf53fce8-def6-4aeb-8d30-b158e7b1cf83"="Microsoft Stream Portal"
    "c1c74fed-04c9-4704-80dc-9f79a2e515cb"="Yammer Web"
    "905fcf26-4eb7-48a0-9ff0-8dcc7194b5ba"="Sway"
    "268761a2-03f3-40df-8a8b-c3db24145b6b"="Universal Store Native Client"
    "93625bc8-bfe2-437a-97e0-3d0060024faa"="Microsoft password reset service"
    "98db8bd6-0cc0-4e67-9de5-f187f1cd1b41"="Microsoft Substrate Management"
    "f5eaa862-7f08-448c-9c4e-f4047d4d4521"="FindTime"
    "e1ef36fd-b883-4dbf-97f0-9ece4b576fc6"="Yammer Web Embed"
    "b4bddae8-ab25-483e-8670-df09b9f1d0ea"="Signup"
    "0000001a-0000-0000-c000-000000000000"="MicrosoftAzureActiveAuthn"
    "bb2a2e3a-c5e7-4f0a-88e0-8e01fd3fc1f4"="CPIM Service"
    "797f4846-ba00-4fd7-ba43-dac1f8f63013"="Windows Azure Service Management API"
    "1b3c667f-cde3-4090-b60b-3d2abd0117f0"="Windows Spotlight"
    "0cd196ee-71bf-4fd6-a57c-b491ffd4fb1e"="Media Analysis and Transformation Service"
    "61109738-7d2b-4a0b-9fe3-660b1ff83505"="SpoolsProvisioning"
    "dfe74da8-9279-44ec-8fb2-2aed9e1c73d0"="O365 SkypeSpaces Ingestion Service"
    "97cb1f73-50df-47d1-8fb0-0271f2728514"="Transcript Ingestion"
    "0f698dd4-f011-4d23-a33e-b36416dcb1e6"="OfficeClientService"
    "91ca2ca5-3b3e-41dd-ab65-809fa3dffffa"="Sticky Notes API"
    "45a330b1-b1ec-4cc1-9161-9f03992aa49f"="Windows Store for Business"
    "497effe9-df71-4043-a8bb-14cf78c4b63b"="Exchange Admin Center"
    "d73f4b35-55c9-48c7-8b10-651f6f2acb2e"="MCAPI Authorization Prod"
    "7ab7862c-4c57-491e-8a45-d52a7e023983"="App Service"
    "18fbca16-2224-45f6-85b0-f7bf2b39b3f3"="Microsoft Docs"
    "51be292c-a17e-4f17-9a7e-4b661fb16dd2"="Microsoft Exchange ProtectedServiceHost"
    "20a11fe0-faa8-4df5-baf2-f965f8f9972e"="ContactsInferencingEmailProcessor"
    "17d5e35f-655b-4fb0-8ae6-86356e9a49f5"="Office Online Client AAD- Maker"
    "a9b49b65-0a12-430b-9540-c80b3332c127"="Office Online Search"
    "67e3df25-268a-4324-a550-0de1c7f97287"="Microsoft Office Web Apps Service"
    "d176f6e7-38e5-40c9-8a78-3998aab820e7"="Microsoft Online Syndication Partner Portal"
    "23523755-3a2b-41ca-9315-f81f3f566a95"="ACOM Azure Website"
    "c9a559d2-7aab-4f13-a6ed-e7e9c52aec87"="Microsoft Forms"
    "00000015-0000-0000-c000-000000000000"="Microsoft Dynamics ERP"
    "b6e69c34-5f1f-4c34-8cdf-7fea120b8670"="Office Online Client MSA- Loki"
    "7b7531ad-5926-4f2d-8a1d-38495ad33e17"="Azure Advanced Threat Protection"
    "74bcdadc-2fdc-4bb3-8459-76d06952a0e9"="Microsoft Intune Web Company Portal"
    "26abc9a8-24f0-4b11-8234-e86ede698878"="SubstrateDirectoryEventProcessor"
    "38049638-cc2c-4cde-abe4-4479d721ed44"="Microsoft Approval Management"
    "0cb7b9ec-5336-483b-bc31-b15b5788de71"="ASM Campaign Servicing"
    "cf36b471-5b44-428c-9ce7-313bf84528de"="Microsoft Bing Search"
    "243c63a3-247d-41c5-9d83-7788c43f1c43"="Office Online Core SSO"
    "08e18876-6177-487e-b8b5-cf950c1e598c"="SharePoint Online Web Client Extensibility"
    "1786c5ed-9644-47b2-8aa0-7201292175b6"="Microsoft Bing Default Search Engine"
    "4b233688-031c-404b-9a80-a4f3f2351f90"="Office.com"
    "de8bc8b5-d9f9-48b1-a8ad-b748da725064"="Graph Explorer"
    "14d82eec-204b-4c2f-b7e8-296a70dab67e"="Microsoft Graph Command Line Tools"
    "7ae974c5-1af7-4923-af3a-fb1fd14dcb7e"="OutlookUserSettingsConsumer"
    "5572c4c0-d078-44ce-b81c-6cbf8d3ed39e"="Vortex [wsfed enabled]"
    "7eadcef8-456d-4611-9480-4fff72b8b9e2"="Microsoft Account Controls V2"
}



$pattern = '\(Country, Region, City\) is: (.+?),.+">'

function Get-IPGeolocation {
  # Performs a Get-IPLocation request to http://fr.geoipview.com/ and parses the HTML in the response to get the country.
  # This approach was chosen over whois as whois can sometimes return multiple records for a single query, making it hard to write a regex/parser that parses the correct country code.
  # The website does not seem to have a rate limit, can make about 30 requests per minute.
  
  Param
  (
    [string]$IPAddress
  ) 
  #From https://github.com/florianburnel/PowerShell/blob/master/NETWORK-Get-IPLocation/Get-IPLocation.ps1
  $WebResult = Invoke-WebRequest -Uri "https://www.whtop.com/tools.ip/$IPAddress" #Not sure if it is throttled
  $matches = $WebResult.Content | Select-String -Pattern $pattern  -CaseSensitive:$false

  # Check if we found any matches
  if ($matches) {
        # Extract the country information from the matched text
        $country = $matches.Matches.Groups[1].Value
        return $country
    }
    else {
        return "Unknown"
    }

}

[regex]$ip_v4_regex = "\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b"
[regex]$ip_v6_regex = "\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b"

function Parse_IPAddresses{
    <#Used to parse the ipv4 and normal ipv6 addresses from the IP_addr_string,
    which can be useful when the IP address contains port values#>

    param(
        [string]$IP_addr_str
    )

    $ip_v4_addr = $ip_v4_regex.Matches($IP_addr_str)|foreach-Object{$_.Value}
    
    if ($ip_v4_addr -ne $null){
        return $ip_v4_addr
    }
    else{
        $ip_v6_addr = $ip_v6_regex.Matches($IP_addr_str)|foreach-Object{$_.Value}

        if ($ip_v6_addr -ne $null){
            return $ip_v6_addr
        }
        else{
            # If unable to determine ipv4 or ipv6 address, return back the original ipaddress string
            # This will be passed to get_country_from_api function, where only in the case where the country
            # is unknown, will the ipaddress be deemed as unknown.
            return $IP_addr_str
        }
    }
    
}


function get_country_from_api {
    <#There are 4 possible situations:
        1. Both IP and UserID are present
        2. Only IP is present
        3. Only UserID is present
        4. Neither IP nor UserID is present

        For 1, we will get the country from the IP address and add it to the hashtable.
        For 2, we will add the IP address statistics to the user "Unknown" in the hashtable.
        For 3 and 4, a new entry for the UserId is created in the hashtable and the IP address count statistics are tracked.
               For the case of 4, the UserId is set to "Unknown".
               The IP address is set to "No IP" and Country is set to "None".
    #>
    param (
        [Array]$audit_logs_arr,
        [hashtable]$IP_addr_to_country_hash,
        [hashtable]$IP_addr_count
    )
    foreach($audit_log in $audit_logs_arr){
        $client_ip_addr=$audit_log."ClientIP"
        $country = $null

        if ($client_ip_addr -eq $null){
            #Field used in the ExchangeMailbox schema
            $client_ip_addr = $audit_log."ClientIPAddress"
        }

        $client_ip_addr = Parse_IPAddresses $client_ip_addr
        $user_id = $audit_log."UserId"

        if ($user_id -eq $null){
            $user_id = "Unknown"
        }

        If([bool]$client_ip_addr ){
            #Only works for IPv4 addresses
            If (!($IP_addr_to_country_hash[$client_ip_addr])) {
                $country = Get-IPGeolocation -IPAddress $client_ip_addr
                $IP_addr_to_country_hash.Add($client_ip_addr,$country)
            }
            else{
                $country = $IP_addr_to_country_hash[$client_ip_addr]
            }

            if(!($IP_addr_count[$user_id])){
                #First time user is seen
                $single_user_ip_addr_prop = @{
                    "Unique IP Count" =0
                    "IP Properties" = @{
                    }

                }
                $IP_addr_count.Add($user_id,$single_user_ip_addr_prop)
            }

            if (!($IP_addr_count[$user_id]["IP Properties"][$client_ip_addr])){
                $intial_ip_properties=@{
                    "Country"= $country
                    "Count"= 1
                }
                $IP_addr_count[$user_id]["IP Properties"].Add($client_ip_addr,$intial_ip_properties)
                $IP_addr_count[$user_id]["Unique IP Count"] += 1
            }
            else{
                $IP_addr_count[$user_id]["IP Properties"][$client_ip_addr]["Count"] += 1
            }
        }
        Else{
            if(!($IP_addr_count[$user_id])){
                $single_user_ip_addr_prop = @{
                    "Unique IP Count" = 0
                    "IP Properties" = @{
                        "No IP" = @{
                            "Country" = "None"
                            "Count" = 1
                        }
                    }

                }
                $IP_addr_count.Add($user_id,$single_user_ip_addr_prop)
            }
            else{
                if (!($IP_addr_count[$user_id]["IP Properties"]["No IP"])){
                    #First time No ClientIP is seen for the user
                    $IP_addr_count[$user_id]["IP Properties"].Add("No IP",@{
                        "Country" = "None"
                        "Count" = 1
                    })
                }
                else{
                    $IP_addr_count[$user_id]["IP Properties"]["No IP"]["Count"] += 1
                }
            }
        }
    }

    foreach($user in $IP_addr_count.Keys){
        $user_ip_properties = $IP_addr_count.$user."IP Properties"
        $unique_countries = @()

        foreach($ipProperty in $user_ip_properties.Values){
            $country = $ipProperty["Country"]
           if (-not ($unique_countries -in $country)){
                $unique_countries += $country
            }
        }

        $IP_addr_count.$user."Unique Countries Count" = $unique_countries.Count
    }

    return $IP_addr_count,$IP_addr_to_country_hash
}


function get_application_name_from_applicationId{
    <#There are 4 possible situations:
    1. Both AppID and UserID are present
    2. Only AppID is present
    3. Only UserID is present
    4. Neither AppID nor UserID is present

    For 1, we will get the name of the appID from $applicationId_to_name_map and add it to the hashtable.
    For 2, we will add the appID statistics to the user "Unknown" in the hashtable.
    For 3 and 4, a new entry for the UserId is created in the hashtable and the AppID count statistics are tracked.
            For the case of 4, the UserId is set to "Unknown".
            The AppID is set to "No AppID" and Name is set to "None"
    #>
    param (
        [Array]$audit_logs_arr,
        [hashtable]$all_mapped_appId
    )

    foreach($audit_log in $audit_logs_arr){
        $app_id=$audit_log."ApplicationId"
        $user_id = $audit_log."UserId"

        if ($user_id -eq $null){
            $user_id = "Unknown"
        }

        If($app_id -ne $null){
           if (!($all_mapped_appId[$user_id])){
                #First time user is seen
                $single_user_appId_prop = @{
                    "Unique Count" =0
                     "AppID Properties" = @{}

                }
                $all_mapped_appId.Add($user_id,$single_user_appId_prop)
           }

           if (!($all_mapped_appId[$user_id]["AppID Properties"][$app_id])){
                $initial_appId_properties =@{
                    "Count" =1
                }
                $app_name = $applicationId_to_name_map[$app_id]

                if($app_name){
                    $initial_appId_properties.Add("Name",$app_name)
                }
                else{
                    $initial_appId_properties.Add("Name","Unknown")
                }

                $all_mapped_appId[$user_id]["AppID Properties"].Add($app_id,$initial_appId_properties)
                $all_mapped_appId[$user_id]["Unique Count"] += 1
           }
           else{
            $all_mapped_appId[$user_id]["AppID Properties"][$app_id]["Count"]+=1
           }
        }
        Else{
            if (!($all_mapped_appId[$user_id])){
                #First time user is seen
                $single_user_appId_prop = @{
                    "Unique Count" =0
                     "AppID Properties" = @{
                            "No AppID" = @{
                                "Name" = "None"
                                "Count" = 1
                            }
                     }

                }
                $all_mapped_appId.Add($user_id,$single_user_appId_prop)
           }
           else{
                if (!($all_mapped_appId[$user_id]["AppID Properties"]["No AppID"])){
                    $all_mapped_appId[$user_id]["AppID Properties"].Add("No AppID",@{
                        "Name" = "None"
                        "Count" = 1
                    })
                }
                else{
                    $all_mapped_appId[$user_id]["AppID Properties"]["No AppID"]["Count"]+=1
                }
           }
        }
    }
    return $all_mapped_appId
}

function get_utc_from_date_and_time_input{
    #Used to convert the date and time derived from the user input parameters to UTC time.
    #The reason for this is that the Search-UnifiedAuditLog stores logs in UTC.

    param(
        $date,
        [String]$time
    )

    if (!$time){
        $time = "12:00 AM"
    }

    #Using toShortDateString() will keep the date in the same format (ddMMyyyy or MMddyyyy) as the same culture of the sytem.
    $date_string = $date.toShortDateString()

    $utc_date = $date_string+" "+$time
    return $date_string,$time,(Get-Date $utc_date).ToUniversalTime()
}
